# External Stub

Заглушка для тестов/нагрузки/локальной разработки пр.
Позволяет матчить запросы по хедерам и пэйлоаду и настраивать множественные варианты ответа

##### Для локального запуска требуется:
* _Java_ 21+
* _gradle_ 8+
* _postgres_ - localhost:5432/postgres (postgres:postgres)
* _artemis_ - localhost:61616

##### Swagger
Доступен Swagger по пути http://localhost:9999/swagger-ui/index.html

##### Добавление ответов для заглушения MQ очередей:
###### Используя REST:

Вызвать
```
POST /response/mq
```

В теле передать объект вида:
```json
{
  "headerKey": "correlationId",
  "headerValue": "1212",
  "queue": "INT.QUEUE.IN",
  "responseBody": "{\"status\":\"OK\"}",
  "payloadType": "JSON",
  "matchingExpression": "$..messageId",
  "delayInSec": 0,
  "ttlInSec": 0
}
```
| Field              | Type           | Required | Default value |                                                                                                                                                                             |
|--------------------|----------------|----------|---------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| headerKey          | String         |          |               | имя хедера из входящего сообщения по которому нужно матчить этот ответ. Если не задавать то будут заглушены все входящие запросы в эту очередь                              |
| headerValue        | String         |          |               | значение хедера из входящего сообщения. Задается если указан headerKey                                                                                                      |
| queue              | String         | *        |               | имя очереди                                                                                                                                                                 |
| responseBody       | String         | *        |               | ответ который вернут заглушка                                                                                                                                               |
| payloadType        | Enum: JSON/XML |          | JSON          | формат сообщения в очереди                                                                                                                                                  |
| matchingExpression | String         |          |               | JsonPath/Xpath которому должен соответствовать payload запроса. Используется если нужно вернуть разные ответы для одной очереди в зависимости от пейлоада входящего запроса |
| delayInSec         | Long           |          | 0             | Задержка в секундах перед тем как заглушка вернет ответ                                                                                                                     |
| ttlInSec           | Long           |          | 0             | Период в секундах сколько будет храниться правило в сервисе. По умолчанию 1 день. Если указать 0 будет храниться бесрочно                                                   |

###### Через БД
Таблица _external_stub.mq_response_

| Field               | Type                     | NULLABLE |                                                                                                                                                                             |
|---------------------|--------------------------|----------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| header_key          | varchar                  |          | имя хедера из входящего сообщения по которому нужно матчить этот ответ. Если не задавать то будут заглушены все входящие запросы в эту очередь                              |
| header_value        | varchar                  |          | значение хедера из входящего сообщения. Задается если указан headerKey                                                                                                      |
| queue               | varchar                  |          | имя очереди                                                                                                                                                                 |
| response_body       | varchar                  |          | ответ который вернут заглушка                                                                                                                                               |
| payload_type        | Enum: JSON/XML           |          | формат сообщения в очереди                                                                                                                                                  |
| matching_expression | varchar                  |          | JsonPath/Xpath которому должен соответствовать payload запроса. Используется если нужно вернуть разные ответы для одной очереди в зависимости от пейлоада входящего запроса |
| delay_in_sec        | long                     |          | Задержка в секундах перед тем как заглушка вернет ответ                                                                                                                     |
| ttl_in_sec          | timestamp with time zone | *        | ДатаВремя после которого запись из БД будет удалена                                                                                                                         |

Чтобы приложение стал слушать очередь добавленную через БД, необходимо вызвать REST: `POST /response/mq/reload`

Матчинг по JsonPath/XPath работает как поиск в пейлоаде нод/элементов которые удовлетворяют заданному выражению. 
Если таких нод более 0 считается что пэйлоад матчится по заданному выражению
##### Примеры JsonPath
| JsonPath                                     | Description                                                                                                                     |
|----------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------|
| $.[?(@.fieldName == 'fieldValue')]           | В json есть поле fieldName (на любой глубине, но не внутри массива) со значением fieldValue                                     |
| $..fieldName                                 | В json есть поле fieldName (на любой глубине)                                                                                   |
| $..arrayName[?(@.fieldName == 'fieldValue')] | В json есть поле arrayName которое является массивом и в нем есть элемент у которого есть поле fieldName со значеним fieldValue |

##### Примеры XPath
| XPath        | Description                                               |
|--------------|-----------------------------------------------------------|
| //XmlElement | В xml есть элемент с именем XmlElement (на любой глубине) |



##### Добавление ответов для заглушения REST очередей
###### Через REST

Вызвать `POST /response/rest`
В теле передать объект вида:
```json
{
  "headerKey": "correlationId",
  "headerValue": "1212",
  "method": "GET",
  "path": "requests/1/documents",
  "responseStatus": 200,
  "responseBody": "{\"status\":\"OK\"}",
  "delayInSec": 0,
  "ttlInSec": 0
}
```
| Field          | Type   | Required | Default |                                                                                                                           |
|----------------|--------|----------|---------|---------------------------------------------------------------------------------------------------------------------------|
| headerKey      | String |          |         | имя хедера из запроса                                                                                                     |
| headerValue    | String |          |         | значение хедера из запроса                                                                                                |
| method         | String | *        |         | GET, PUT, POST, PATCH, DELETE                                                                                             |
| path           | String | *        |         | Mocked Rest method path                                                                                                   |
| responseStatus | Int    |          | 200     | Http response code                                                                                                        |
| responseBody   | String | *        |         | Http response body                                                                                                        |
| delayInSec     | Long   |          | 0       | Задержка в секундах перед тем как заглушка вернет ответ                                                                   |
| ttlInSec       | Long   |          | 0       | Период в секундах сколько будет храниться правило в сервисе. По умолчанию 1 день. Если указать 0 будет храниться бесрочно |

Либо можно через БД добавить в таблицу _external_stub.rest_response_ (дергать REST после этого не нужно)
!!! На стороне приложения которое должно вызывать заглушаемый REST нужно указать url вида `http://<stubber-host>:9999/stub`